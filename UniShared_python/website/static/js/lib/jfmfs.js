// Copyright 2010 Mike Brevoort http://mike.brevoort.com @mbrevoort
// 
// v5.0 jquery-facebook-multi-friend-selector
// 
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
// 
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
(function(a){var b=function(b,c){var d=a(b),e=this,f=[],g,h=0,i=0,j;var k=a.extend({max_selected:-1,max_selected_message:"{0} of {1} selected",pre_selected_friends:[],exclude_friends:[],friend_fields:"id,name",sorter:function(a,b){var c=a.name.toLowerCase();var d=b.name.toLowerCase();return c<d?-1:c>d?1:0},labels:{selected:"Selected",filter_default:"Start typing a name",filter_title:"Find Friends:",all:"All",max_selected_message:"{0} of {1} selected"}},c||{});var l;var m=function(a){var b={};for(var c=0,d=a.length;c<d;c++){b[a[c]]=""}return b};d.html("<div id='jfmfs-friend-selector'>"+"    <div id='jfmfs-inner-header'>"+"        <span class='jfmfs-title'>"+k.labels.filter_title+" </span><input type='text' id='jfmfs-friend-filter-text' value='"+k.labels.filter_default+"'/><span class='icon-remove'></span>"+"        <a class='filter-link selected' id='jfmfs-filter-all' href='#'>"+k.labels.all+"</a>"+"        <a class='filter-link' id='jfmfs-filter-selected' href='#'>"+k.labels.selected+" (<span id='jfmfs-selected-count'>0</span>)</a>"+(k.max_selected>0?"<div id='jfmfs-max-selected-wrapper'></div>":"")+"    </div>"+"    <div id='jfmfs-friend-container'></div>"+"</div>");var n=a("#jfmfs-friend-container"),o=a("#jfmfs-friend-selector"),p=m(k.pre_selected_friends),q=m(k.exclude_friends),r;FB.api("/me/friends?fields="+k.friend_fields,function(b){var c=b.data.sort(k.sorter),e={},g=[],h="";a.each(c,function(a,b){if(!(b.id in q)){h=b.id in p?"selected":"";g.push("<div class='jfmfs-friend "+h+" ' id='"+b.id+"'><img/><div class='friend-name'>"+b.name+"</div></div>")}});n.append(g.join(""));f=a(".jfmfs-friend",d);f.bind("inview",function(b,c){if(a(this).attr("src")===undefined){a("img",a(this)).attr("src","//graph.facebook.com/"+this.id+"/picture")}a(this).unbind("inview")});s()});this.getSelectedIds=function(){var b=[];a.each(d.find(".jfmfs-friend.selected"),function(c,d){b.push(a(d).attr("id"))});return b};this.getSelectedIdsAndNames=function(){var b=[];a.each(d.find(".jfmfs-friend.selected"),function(c,d){b.push({id:a(d).attr("id"),name:a(d).find(".friend-name").text()})});return b};this.clearSelected=function(){r.removeClass("selected");t()};var s=function(){r=a(".jfmfs-friend",d);j=r.first().offset().top;for(var b=0,c=r.length;b<c;b++){if(a(r[b]).offset().top===j){h++}else{i=a(r[b]).offset().top-j;break}}d.delegate(".jfmfs-friend","click",function(b){var c=k.max_selected===1,f=a(this).hasClass("selected"),g=a(".jfmfs-friend.selected").length>=k.max_selected,h=n.find(".selected").attr("id")===a(this).attr("id");if(!c&&!f&&v()&&g)return;if(c&&!h){n.find(".selected").removeClass("selected")}a(this).toggleClass("selected");a(this).removeClass("hover");if(a(this).hasClass("selected")){if(!l){l=a(this)}else{if(b.shiftKey){var i=a(this).index(),j=l.index(),m=Math.max(i,j),o=Math.min(i,j);for(var p=o;p<=m;p++){var q=a(r[p]);if(!q.hasClass("hide-non-selected")&&!q.hasClass("hide-filtered")){if(v()&&a(".jfmfs-friend.selected").length<k.max_selected){a(r[p]).addClass("selected")}}}}}}l=a(this);t();if(v()){w()}d.trigger("jfmfs.selection.changed",[e.getSelectedIdsAndNames()])});a("#jfmfs-filter-selected").click(function(b){b.preventDefault();r.not(".selected").addClass("hide-non-selected");a(".filter-link").removeClass("selected");a(this).addClass("selected")});a("#jfmfs-filter-all").click(function(b){b.preventDefault();r.removeClass("hide-non-selected");a(".filter-link").removeClass("selected");a(this).addClass("selected")});d.find(".jfmfs-friend:not(.selected)").live("hover",function(b){if(b.type=="mouseover"){a(this).addClass("hover")}if(b.type=="mouseout"){a(this).removeClass("hover")}});d.find("#jfmfs-friend-filter-text").keyup(function(){var b=a(this).val();clearTimeout(g);g=setTimeout(function(){if(b==""){r.removeClass("hide-filtered")}else{o.find(".friend-name:not(:Contains("+b+"))").parent().addClass("hide-filtered");o.find(".friend-name:Contains("+b+")").parent().removeClass("hide-filtered")}m()},400)}).focus(function(){if(a.trim(a(this).val())=="Start typing a name"){a(this).val("")}}).blur(function(){if(a.trim(a(this).val())==""){a(this).val("Start typing a name")}});d.find(".icon-remove").click(x);d.find(".jfmfs-button").hover(function(){a(this).addClass("jfmfs-button-hover")},function(){a(this).removeClass("jfmfs-button-hover")});var f=function(){var b=window.innerHeight;var c=document.compatMode;if(c||!a.support.boxModel){b=c=="CSS1Compat"?document.documentElement.clientHeight:document.body.clientHeight}return b};var m=function(){var b=n.innerHeight(),c=n.scrollTop(),d=n.offset().top,e,f,g=0,k=false,l=a(".jfmfs-friend:not(.hide-filtered )");a.each(l,function(e,m){g++;if(m!==null){m=a(l[e]);f=j+i*Math.ceil(g/h)-c-d;if(f+i>=-10&&f-i<b){m.data("inview",true);m.trigger("inview",[true]);k=true}else{if(k){return false}}}})};n.bind("scroll",a.debounce(250,m));w();m();t();d.trigger("jfmfs.friendload.finished")};var t=function(){a("#jfmfs-selected-count").html(u())};var u=function(){return a(".jfmfs-friend.selected").length};var v=function(){return k.max_selected>0};var w=function(){var b=k.labels.max_selected_message.replace("{0}",u()).replace("{1}",k.max_selected);a("#jfmfs-max-selected-wrapper").html(b)};var x=function(){r.removeClass("hide-filtered");d.find("#jfmfs-friend-filter-text").val("");d.find("#jfmfs-friend-filter-text").trigger("blur")};this.resetFilter=x};a.fn.jfmfs=function(c){return this.each(function(){var d=a(this);if(d.data("jfmfs")){return}var e=new b(this,c);d.data("jfmfs",e)})};a.expr[":"].Contains=function(b,c,d){return a(b).text().toUpperCase().indexOf(d[3].toUpperCase())>=0}})(jQuery);if($.debounce===undefined){(function(a,b){var c=a.jQuery||a.Cowboy||(a.Cowboy={}),d;c.throttle=d=function(a,d,e,f){function i(){function l(){h=+(new Date);e.apply(c,k)}function m(){g=b}var c=this,i=+(new Date)-h,k=arguments;if(f&&!g){l()}g&&clearTimeout(g);if(f===b&&i>a){l()}else{if(d!==true){g=setTimeout(f?m:l,f===b?a-i:a)}}}var g,h=0;if(typeof d!=="boolean"){f=e;e=d;d=b}if(c.guid){i.guid=e.guid=e.guid||c.guid++}return i};c.debounce=function(a,c,e){return e===b?d(a,c,false):d(a,e,c!==false)}})(this)}
